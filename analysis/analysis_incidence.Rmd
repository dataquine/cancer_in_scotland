---
title: "Analysis: Incidence of cancer in Scotland"
author: "Lesley Duff"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
---
```{r setup_incidence, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = FALSE,
  message = FALSE
)
```

```{r}
library(dplyr)
library(gt)
library(readr)
library(stringr)
```

```{r}
source(here::here("R/phs_data_info.R"))
source(here::here("R/theming.R"))
```

```{r}
# Set custom theme
theme_set(theme_cancer_in_scotland()) # base_size=14))
```
# Incidence
## Background

There are multiple different types of cancer. We would like to find out which 
types have been recorded in Scotland and how these have changed over time. 
Different cancers are coded according to World Health Organisation standards.
In Scotland the ICD 10 Code is used when a patient is diagnosed.

Terminology: `cancer site` - the place where a cancer starts in the body

The Scottish Cancer Registry (SMR06) collates this information but it can only 
be directly accessed by people in the NHS.


Public Health Scotland (PHS) makes available aggregated opendata extracted from 
the registry via 
[Annual Cancer Incidence](https://www.opendata.nhs.scot/dataset/annual-cancer-incidence)

The following dataset gives us an nnual number and rate of new cancer 
registrations in Scotland by sex and age. Reports include data from 1997 to 2021.

**Source:**  [Incidence at Scotland Level](https://www.opendata.nhs.scot/dataset/c2c59eb1-3aff-48d2-9e9c-60ca8605431d/resource/72c852b8-ee28-4fd8-84a9-5f415f4bc325/download/opendata_inc9721_scotland.csv). 
PHS Last update: 29 March 2023.
 
This analysis utilises PHS data.

## Analysis

```{r}
# Read in clean cancer death data
incidence <- read_csv(here::here(
  "data_clean", phs_incidence_filepath
))
```

```{r eval=FALSE, include=FALSE}
skimr::skim(incidence)

# N.B this dataset now has over a million rows as it was originally wide and
# contains both numbers and rates

incidence %>%
  count(cancer_site, sex, year)

head(incidence)
```
### Time
```{r}
# names(incidence)

# Top level for total all cancers per year = count
incidences_by_year <- incidence %>%
  mutate(cancer_site = str_trunc(cancer_site, 30)) %>%
  # Only interested in top level numbers
  filter(cancer_site == "All cancer types") %>%
  # Only interested in all sexes
  filter(sex == "All") %>%
  # Only interested in all age ranges
  filter(incidences_age_range == "All ages") %>%
  # select(year, cancer_site,sex,incidences_age_range) %>%
  group_by(year, cancer_site, sex, incidences_age_range, incidences_age) %>%
  summarise() %>%
  ungroup() %>%
  select(year, incidences_age)

range_incidences_by_year <- range(incidences_by_year$incidences_age)
range_incidences_years <- range(incidences_by_year$year)
```

Since `r range_incidences_years[1]`.

#### Cancer Incidences by Year
```{r}
# library(ggrepel)

# Yearly incidences
plot_incidences_by_year <- function(df,
                                    show_covid = TRUE,
                                    plot_title = "Number of Cancer Incidences by Year in Scotland",
                                    plot_x = "",
                                    plot_y = "Incidences\n") {
  plot <- df %>%
    mutate(label = if_else(year == max(year) |
      year == min(year),
    as.character(incidences_age), NA_character_
    )) %>%
    ggplot(aes(x = year, y = incidences_age)) +
    geom_line() +
    #    geom_label_repel(aes(label = label), # ?geom_label_repel
    # nudge_x = 0,
    #     nudge_y = Inf,
    #   na.rm = TRUE
    #    ) +
    geom_hline(
      yintercept = 0,
      #   colour = "red",
      alpha = 0.5,
      linetype = 1
    ) +
    geom_point() +
    scale_y_continuous(label = scales::label_comma()) +
    scale_x_continuous(breaks = seq(
      from = min(df$year),
      to = max(df$year),
      by = 2
    )) +
    theme(
      panel.grid.major.y = element_blank()
      #   panel.grid.major.x = ggplot2::element_line()
    ) +
    labs(
      title = plot_title,
      subtitle = paste(min(df$year), max(df$year), sep = "-"),
      x = plot_x,
      y = plot_y,
      caption = source_phs
    )
  if (show_covid) {
    plot <- plot + geom_vline(
      xintercept = 2020,
      colour = "red",
      alpha = 0.7,
      linetype = 3
    )
    plot <- plot + annotate( # ??annotate
      "label",
      label = "COVID-19",
      colour = "red",
      # annotate("text", x = -Inf, y = Inf,
      x = 2020,
      y = 0
      # hjust = 0.5, vjust = 0,parse = TRUE
    )
  }

  return(plot)
}

plot_incidences_by_year(incidences_by_year)
```

```{r}
lowest_incidences_by_year <- incidences_by_year %>%
  arrange(incidences_age) %>%
  select(year) %>%
  slice(1L) %>%
  pull()

highest_incidences_by_year <- incidences_by_year %>%
  arrange(desc(incidences_age)) %>%
  select(year) %>%
  slice(1L) %>%
  pull()
# lowest_incidences_by_year
# highest_incidences_by_year
```

```{r}
incidences_min_max <- tibble(
  incidences = c(range_incidences_by_year[1], c(range_incidences_by_year[2])),
  year = c(lowest_incidences_by_year, highest_incidences_by_year)
)

incidences_min_max %>%
  gt() %>%
  tab_header(
    title = "Highest and lowest",
    subtitle = glue::glue("Between: {range_incidences_years[1]} and {range_incidences_years[2]}") # %>%
    # fmt_number(columns = incidences, suffixing = TRUE)
  ) %>% 
    fmt_number(columns = incidences,decimals = 0)
```


<!-- |     | Incidences | Year | -->
<!-- | -------- | -------: | ----: | -->
<!-- | **Minimum** | `r format(range_incidences_by_year[1],big.mark=",")` |`r format(lowest_incidences_by_year)`| -->
<!-- | **Maximum** | `r format(range_incidences_by_year[2],big.mark=",")` |`r format(highest_incidences_by_year)`| -->

```{r}
```
