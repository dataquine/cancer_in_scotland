---
title: "Analysis: Incidence of cancer in Scotland"
author: "Lesley Duff"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
---
```{r setup_incidence, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = FALSE,
  message = FALSE
)
```

```{r}
library(dplyr)
library(readr)
library(stringr)
```

```{r}
source(here::here("R/incidence.R"))
source(here::here("R/phs_data_info.R"))
source(here::here("R/theming.R"))
```

```{r}
# Set custom theme
theme_set(theme_cancer_in_scotland()) # base_size=14))
```
# Incidence
```{r}
# Read in clean cancer death data
incidence <- read_csv(here::here(
  "data_clean", phs_incidence_filepath
))
```

```{r eval=FALSE, include=FALSE}
skimr::skim(incidence)

# N.B this dataset now has over a million rows as it was originally wide and
# contains both numbers and rates

incidence %>%
  count(cancer_site, sex, year)

head(incidence)
```

```{r}
incidences_by_year <- get_incidences_by_year(incidence)
lowest_incidences_year <- get_lowest_incidences_by_year(incidences_by_year)
highest_incidences_year <- get_highest_incidences_by_year(incidences_by_year)
lowest_incidences <- min(incidences_by_year$incidences_age)
highest_incidences <- max(incidences_by_year$incidences_age)
lowest_incidences_year <- min(incidences_by_year$year)
highest_incidences_year <- max(incidences_by_year$year)
```

## Background

There are multiple different types of cancer. We would like to find out which 
types have been recorded in Scotland and how these have changed over time. 
Different cancers are coded according to World Health Organisation standards.
In Scotland the ICD 10 Code is used when a patient is diagnosed.

Terminology: `cancer site` - the place where a cancer starts in the body

The Scottish Cancer Registry (SMR06) collects information on every cancer in 
Scotland. However this information can only be directly accessed by people in 
the NHS.

Public Health Scotland (PHS) makes available aggregated opendata extracted from 
the registry via 
[Annual Cancer Incidence](https://www.opendata.nhs.scot/dataset/annual-cancer-incidence)



The following dataset gives us an annual number and rate of new cancer 
registrations in Scotland by sex and age. Reports include data from 1997 to 2021.

**Source:**  [Incidence at Scotland Level](https://www.opendata.nhs.scot/dataset/c2c59eb1-3aff-48d2-9e9c-60ca8605431d/resource/72c852b8-ee28-4fd8-84a9-5f415f4bc325/download/opendata_inc9721_scotland.csv). 
PHS Last update: 29 March 2023.
 
This analysis utilises PHS data.

## Analysis
### Time

Since `r format(lowest_incidences_year)` 

#### Cancer Incidences by Year
```{r}
# Yearly incidences - a line plot
plot_incidences <- plot_incidences_by_year(incidences_by_year)
plot_incidences
ggsave(
  here::here(cancer_incidence_plot_filepath),
  plot_incidences
)
```


```{r}
incidences_min_max <- tibble(
  incidences = c(lowest_incidences, highest_incidences),
  year = c(lowest_incidences_year, highest_incidences_year)
)

incidences_min_max <- table_incidences_min_max(
  incidences_min_max,
  lowest_incidences_year, highest_incidences_year
)
incidences_min_max
```
#### Types
```{r}
incidences_by_cancer_site <- get_incidences_by_cancer_site(incidence)
incidences_by_cancer_site
```
##### Cancer sites - all time
Cancers are coded to World Health Organisation standards. The technical term 
`cancer site` refers to where the cancer orginally appeared in the body.
Here is the list of cancer types for which incidences have been recorded in 
Scotland sorted by most common first. These are the totals across multiple years and all ages and sexes.

```{r}
cancer_site <- incidences_by_cancer_site %>%
  select(cancer_site, incidences_age) %>%
  group_by(cancer_site) %>%
  summarise(total = sum(incidences_age))

cancer_site
```


```{r}
names(incidences_by_cancer_site)
incidences_by_cancer_site %>%
  group_by(year, cancer_site, incidences_age) %>%
  summarise()
```




***
```{r}
rm(list = ls(pattern = "incidences_"))
rm(incidence)
```
